# Henry III Voice Calling — Architecture & Setup Guide

## Overview
Two-way realtime voice calling between a phone and an AI (Henry III), with tool access to Clawdbot capabilities.

## Architecture Flow
```
Phone Call → Twilio (PSTN) → ngrok tunnel → Local Server (Fastify) → OpenAI Realtime API
                                                    ↓
                                            Tool Execution
                                    (Weather, Tasks, Calendar, etc.)
```

## Components

### 1. Twilio (Phone Network)
- **What:** Connects real phone calls to our server via Media Streams (WebSocket audio)
- **Account:** paul@heth.ca (or henry@heth.ca — check dashboard)
- **Dashboard:** https://console.twilio.com
- **Phone Number:** [REDACTED]
- **Account SID:** [REDACTED]
- **Auth Token:** in voice-realtime/.env
- **Cost:** Pay-per-call (pennies per minute)

### 2. ngrok (Tunnel)
- **What:** Exposes local server to the internet so Twilio can reach it
- **Auth Token:** [REDACTED]
- **Stable URL:** fausto-acclimatizable-compellably.ngrok-free.dev
- **Login:** Unknown — check paul@heth.ca or henry@heth.ca at https://dashboard.ngrok.com
- **Start:** `ngrok http 6060`
- **Tier:** Free (adds latency; paid or Tailscale Funnel would improve)

### 3. Local Server (Fastify + WebSocket)
- **What:** Bridges Twilio audio ↔ OpenAI Realtime API, executes tools
- **Code:** `/Users/henry_notabot/clawd/voice-realtime/index.js`
- **Port:** 6060
- **Start:** `cd voice-realtime && node index.js`
- **Config:** `voice-realtime/.env`
- **Dependencies:** `voice-realtime/package.json` (fastify, ws, twilio, dotenv)

### 4. OpenAI Realtime API
- **What:** Handles speech-to-speech AI conversation + function calling
- **Model:** gpt-realtime
- **API Key:** [REDACTED]
- **Billing:** https://platform.openai.com/settings/organization/billing
- **Voice:** alloy (default)
- **VAD Settings:** threshold=0.6, silence=500ms, prefix=200ms

### 5. Tailscale (Future — not active yet)
- **What:** Would replace ngrok with direct tunnel (lower latency)
- **Login:** GitHub account (HenryHeth)
- **Hostname:** henry-voice
- **Tailnet URL:** henry-voice.tail20b244.ts.net
- **Blocker:** VM can't grant macOS VPN permission in System Settings
- **Installed:** brew, v1.94.1

## Tools Available During Calls
| Tool | What it does | Backend |
|------|-------------|---------|
| check_weather | Weather for any location | wttr.in API |
| search_tasks | Search Toodledo by keyword | toodledo.js find |
| list_tasks | List tasks in a folder (capped at 10) | toodledo.js list |
| add_task | Create a new task | toodledo.js add |
| check_calendar | Upcoming events | gog calendar list |
| send_message_to_clawdbot | Queue a request for later | writes to voice-requests.log |

## .env File (voice-realtime/.env)
```
TWILIO_ACCOUNT_SID=[REDACTED]
TWILIO_AUTH_TOKEN=[REDACTED]
PHONE_NUMBER_FROM=[REDACTED]
DOMAIN=fausto-acclimatizable-compellably.ngrok-free.dev
OPENAI_API_KEY=[REDACTED]
```

## How to Start (3 steps)
1. `ngrok http 6060` — start tunnel
2. `cd ~/clawd/voice-realtime && node index.js` — start server
3. Call: `curl -s -X POST http://localhost:6060/make-call -H "Content-Type: application/json" -d '{"to": "[REDACTED]"}'`

## Custom Calls (e.g., ordering pizza)
```bash
curl -s -X POST http://localhost:6060/make-call \
  -H "Content-Type: application/json" \
  -d '{
    "to": "[REDACTED]",
    "noTools": true,
    "systemPrompt": "You are calling a pizza restaurant to place an order...",
    "greeting": "Say hi, you would like to place an order..."
  }'
```

## Key Files
- `voice-realtime/index.js` — main server code
- `voice-realtime/.env` — credentials
- `voice-realtime/package.json` — dependencies
- `memory/research_voice_calling.md` — initial research
- `voice-pipeline-diagram.png` — architecture diagram (generated by Nano Banana Pro)

## What's Working
- [x] Outbound calls to any number
- [x] Two-way realtime conversation
- [x] AI greeting on pickup
- [x] Interrupt handling (barge-in)
- [x] Tool calling (weather, tasks, calendar)
- [x] Custom per-call instructions (pizza ordering!)
- [x] Full transcript logging (both sides)

## What's Next (Phase 2)
- [ ] VAD tuning — reduce false triggers
- [ ] Reduce latency — ngrok paid or Tailscale Funnel
- [ ] Better task filtering (by date, priority, folder)
- [ ] Test add_task tool
- [ ] Inbound calling support
- [ ] Voice selection
- [ ] Clawdbot deep integration (email, web search, etc.)